System.register(["jimu-core","jimu-for-builder","jimu-ui","jimu-ui/basic/imagecrop"],(function(t,e){var o={},i={},n={},r={};return{setters:[function(t){o.Immutable=t.Immutable,o.React=t.React,o.ReactDOM=t.ReactDOM,o.appActions=t.appActions,o.getAppStore=t.getAppStore},function(t){i.getAppConfigAction=t.getAppConfigAction},function(t){n.CropType=t.CropType},function(t){r.ImageCrop=t.ImageCrop}],execute:function(){t((()=>{"use strict";var t={79244:t=>{t.exports=o},4108:t=>{t.exports=i},14321:t=>{t.exports=n},44456:t=>{t.exports=r}},e={};function p(o){var i=e[o];if(void 0!==i)return i.exports;var n=e[o]={exports:{}};return t[o](n,n.exports,p),n.exports}p.d=(t,e)=>{for(var o in e)p.o(e,o)&&!p.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},p.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),p.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},p.p="";var s={};p.r(s),p.d(s,{default:()=>u});var a=p(79244),g=p(4108),c=p(14321),m=p(44456);class l extends a.React.PureComponent{constructor(t){super(t),this.__unmount=!1,this.preloadImage=t=>{this.imgObject=new Image,this.imgObject.src=t;const e=this;this.imgObject.onload=t=>{e.imgObject&&(e.__unmount||e.setState({imageWidth:e.imgObject.width,imageHeight:e.imgObject.height}))}},this.getCropZoomInCropTool=(t,e,o,i,n)=>{const r=t&&t.cropPixel,p=t&&t.cropZoom;let s=null,a=null,g=null,c=null;if(r&&p){const t=r.width,a=r.height;let m=null;e/o>=i/n?(g=e,c=n/i*g,e/o>=t/a?(m=e/(t*p),s=n*p*m/c):(m=o/(a*p),s=n*p*m/c)):(c=o,g=i/n*c,e/o>=t/a?(m=e/(t*p),s=n*p*m/c):(m=o/(a*p),s=n*p*m/c))}else e/o>=i/n?(g=e,c=n/i*g):(c=o,g=i/n*c),s=1;return a=g*s/i,a},this.getCropPositionInCropTool=(t,e)=>{const o=t&&t.cropPosition;return o?{x:e*o.x/t.cropZoom,y:e*o.y/t.cropZoom}:{x:0,y:0}},this.onCancelCrop=()=>{(0,a.getAppStore)().dispatch(a.appActions.setWidgetIsInlineEditingState(this.props.widgetId,!1))},this.onConfirmCrop=(t,e)=>{let o=this.props.config.functionConfig.imageParam;if(t.cropType===c.CropType.Real&&e&&(o=o.set("url",e.blobUrl).set("fileFormat",e.fileFormat)),o=o.set("cropParam",t),t.cropPixel){(0,a.getAppStore)().dispatch(a.appActions.setWidgetIsInlineEditingState(this.props.widgetId,!1));let t=(0,a.Immutable)(this.props.config.functionConfig);t=t.set("isCropped",!0),t=t.set("imageParam",o),(0,g.getAppConfigAction)().editWidgetConfig(this.props.widgetId,this.props.config.set("functionConfig",t)).exec()}},this.state={imageWidth:null,imageHeight:null,clientRect:{width:this.props.widgetWidth||0,height:this.props.widgetHeight||0,x:0,y:0,bottom:0,left:0,right:0,top:0,toJSON:()=>{}}}}componentDidMount(){this.__unmount=!1,this.preloadImage(this.props.config.functionConfig.imageParam.originalUrl);const t=document.querySelector(`.widget-renderer[data-widgetid='${this.props.widgetId}']`);t&&this.setState({clientRect:t.getBoundingClientRect()})}componentWillUnmount(){this.__unmount=!0,this.props.onUnmount&&this.props.onUnmount()}render(){const t=this.props.config.functionConfig.imageParam&&this.props.config.functionConfig.imageParam.cropParam,e=this.props.widgetWidth,o=this.props.widgetHeight;if(this.state.imageWidth&&this.state.imageHeight){const i=this.getCropZoomInCropTool(t,e,o,this.state.imageWidth,this.state.imageHeight),n=this.getCropPositionInCropTool(t,i),r=this.props.config.functionConfig.imageParam.originalUrl;return a.React.createElement(m.ImageCrop,{crop:n,cropZoom:i,imageFormat:this.props.config.functionConfig.imageParam.fileFormat,onCancelCrop:this.onCancelCrop,widgetArea:this.state.clientRect,cropParam:t,originId:this.props.config.functionConfig.imageParam.originalId,widgetId:this.props.widgetId,image:r,onConfirmCrop:this.onConfirmCrop,cropType:"BY_URL"===this.props.config.functionConfig.imageParam.imgSourceType?c.CropType.Fake:null})}return a.ReactDOM.createPortal(a.React.createElement("div",null,a.React.createElement("div",{className:"jimu-widget",style:{zIndex:9999,position:"fixed",top:0,left:0,backgroundColor:"rgb(0, 0, 0, .5)"}}),a.React.createElement("div",{style:{position:"absolute",left:"50%",top:"50%",zIndex:9999},className:"jimu-secondary-loading"})),document&&document.getElementsByTagName("body")[0])}}const u={WidgetInBuilder:l};return s})())}}}));